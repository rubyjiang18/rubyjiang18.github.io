---
title: 'Notes of 推荐系统公开课 by Shusen Wang'
date: 2024-06-07
permalink: /posts/2024/06/blog-post-4/
tags:
  - learning
  - career
---

Disclaimer: The content herein is sourced from Shusen Wang's YouTube Channel, specifically the Playlist titled [Recommendation System]((https://www.youtube.com/playlist?list=PLvOO0btloRntAi-VnV06M1Bu0X1xljUUP)). This post is intended for personal study purposes.

------

## <span>概要</span><a id="概要"></a>
### <span style="font-size:smaller; color:LightCoral">概要01</span> 推荐系统的基本概念
转化流程
```
曝光（Impression） --> 点击（Click） --> 滑动到底(ScrowToEnd), 点赞(Like), 收藏(Collect), 转发(Share) --> 评论(Comment)
```

（短期）消费指标：
- 点击率 = 点击次数 / 曝光次数
- 点赞率 = 点赞次数 / 点击次数
- 收藏率 = 收藏次数 / 点击次数
- 转发率 = 转发次数 / 点击次数
- 阅读完成率 = 滑动到底次数 / 点击次数 $\times f$(笔记长度) 

虽然点击率是重要的优化指标，但不能是唯一的指标，否则骗点击的标题就会泛滥。其他指标也可以反映出用户对笔记的兴趣。
$f$(笔记长度) 是一个归一化的函数，这是因为笔记越长，完成阅读的比例就越低。如果没有这个归一化的函数，对长笔记不公平。
注意：一味追求短期消费指标是不对的。举个例子，如果推荐算法只看用户短期兴趣，推很多用户最近感兴趣的内容，这些消费指标上涨，这样的坏处是会竭泽而渔，用户会很快失去兴趣，不再回来；反过来，如果把多样性做好，尝试一些用户没看过的话题，那么点击率不会上涨，但是会有利于提高用户粘性，留住用户，让用户更活跃。

衡量推荐系统的好坏，最重要的指标叫北极星指标，即最关键的指标，是衡量推荐系统好坏的根本标准。

北极星指标
- 用户规模：DAU， MAU
- 消费：人均使用推荐的时长，人均阅读笔记的数量
- 发布：发布渗透率、人均发布量

实验流程
- 离线实验 
    - 收集历史数据，在历史数据上做训练、测试。算法没有部署到产品中，没有跟用户交互。
    - 结果有参考价值，但没有线上实验可靠，也无法得到线上指标。
- 小流量AB测试
    - 算法部署到实际产品中，用户实际跟算法做交互。
    - 可以得到线上指标，如北极星指标。
- 全流量上线

### <span style="font-size:smaller; color:LightCoral">概要02</span> 推荐系统的链路
```
--几亿物品--> 召回 --几千物品--> 粗排 --几百物品--> 精排 --几百物品--> 重排 --几十物品-->
```

- 召回
    - 当用户刷新小红书时，系统会同时调用几十条召回通道，每条召回通道取几十到几百笔记，一共取几千篇笔记
- 粗排
    - 用规模比较小的机器学习模型给几千篇笔记逐一打分，按照分数做排序和截断，保留分数最高的几百篇笔记
- 精排
    - 这里要用大规模的神经网络为几百篇笔记逐一打分，精排的分数反映出用户对笔记的兴趣
    - 精排之后，可以做截断，也可以不做截断。小红书的精排不做截断，几百篇笔记都带着精排分数进入重排
- 重排
    - 重排是最后一步，根据精排分数和多样性分数做随机抽样，得到几十篇笔记
    - 然后把相似内容打散，并且插入广告和运营内容
    - 重拍的规则非常复杂，有好几千行代码

粗排、精排的NN输入是用户特征，物品特征，和统计特征，NN输出点预估的击率，点赞率，收藏率，转发率。融合（加权和）预估值得到最终的排序分数。这个值会决定笔记是否会被展示给用户，靠前或靠后。重排最重要的是做多样性抽样，比如MMR、DPP，从几百篇中选出几十篇。抽样的时候有两个依据，一个是精排分数的大小，一个是多样性。做完抽样后，用规则打散相似笔记，我们不能把内容过于相似的笔记排在相邻的位置上。重排的另一个目的是插入广告、运营推广内容，根据生态要求调整排序，比如不能连着出美女图片。召回和粗排是最大的漏斗，它们让候选笔记的数量从几亿变成几千然后变成几百。当候选笔记之后几百才能用大规模NN做精排，用DPP做抽样。

### <span style="font-size:smaller; color:LightCoral">概要03</span> 推荐系统的AB测试

算法工程师的日常工作就是改进算法的策略，目标是提高推荐系统的业务指标。所有对模型的粗略的改进都需要进行线上的AB测试，用实验数据来验证试验策略是否有效。举个例子解释AB测试的目的是什么：
- 召回团队实现了一种GNN召回通道，离线实验结果正向。但是离线实验的指标有提升未必意味着线上实验也会有收益。
- 做完离线实验，下一步是做线上的小流量AB测试，考察新的召回通道对线上指标的影响，比如DAU，留存，交互等。
- 除了上述目的，模型中的一些参数，比如GNN的深度取值（1，2，3），需要用AB测试选取最优参数。可以同时开三组AB测试，哪组效果好用哪个。

做AB测试需要对用户做随机分桶，比方说：
- 分$b=10$个桶，每个桶中有10%的用户。如果用户的数量足够大，那么每个桶DAU，留存，点击率这些指标都是相等的。
- 首先用哈希函数把用户ID映射成某个区间内的整数，然后把这些整数随机分成$b$个桶。
- 以GNN为例，一号桶实验组#1，以此类推，四号桶为对照组
- 计算每个桶的业务指标，比如DAU，人均使用推荐的时长，点击率等。
- 如果某个实验组指标显著优于对照组，则说明对应的策略有效，值得推全，即把流量扩大到100%。

接下来讲分层实验，用业界实际上就是这么做的。分层实验的目标就是解决流量不够用的问题。举个例子解释，比方说小红书有很多个部门，每个部门有好几个团队，负责推荐系统（召回，粗排，精排，重排），用户界面，广告，所有团队同时需要做实验，线上需要做几十个甚至上百个实验。如果把用户随机分成10组，1组作对照，9组作实验，那么只能同时做9组实验，根本无法满足产品迭代的需求。解决方案就是分层实验：
- 把实验分成很多层，比如召回，粗排，精排，重排，用户界面，广告，...
- 同层是实验之间需要互斥：比如GNN实验占了召回层的4个桶，其他召回实验只能用剩余的6个桶。同层互斥的目的是避免一个用户同时被两个召回实验影响。如果两个实验相互干扰，实验结果会变的不可控。
- 不同层之间流量正交：每一层都独立随机对用户做分桶。每一层都可以独立用100%的用户做实验。召回和粗排的用户是独立随机划分的，召回的2号桶和粗排的2号桶交集很小。
- 分层实验参考文献 Tang et al. Overlapping experiment infrastructure: more, better, faster experimentation. In KDD, 2020. [PDF](https://dl.acm.org/doi/pdf/10.1145/1835804.1835810) 

举个例子，召回层和精排层各自独立随机把用户分成10个桶：
- 召回层把用户分成10个桶：$u_1, u_2, ..., u_{10}$
- 精排层把用户分成10个桶：$v_1, v_2, ..., v_{10}$
- 设系统一共有$n$个用户，那么$\lvert u_i \rvert=\lvert v_j \rvert=n/10$
- 召回桶$u_i$和召回桶$u_j$的交集为$u_i \cap u_j=\varnothing$，即同层互斥，两个召回实验不会同时作用到同一用户上。
- 召回桶$u_i$和精排桶$v_j$的交集为$u_i \cap v_j=n/100$。一个用户不能同时被两个召回实验影响，但可以同时受一个召回实验和一个精排实验影响。一个召回实验和一个精排实验各自作用在$n/10$个用户上，那么有$n/100$的用户同时被召回实验和精排实验影响，即不同层正交。




## <span>召回</span><a id="召回"></a>
### <span style="font-size:smaller; color:LightCoral">召回01</span> 基于物品的协同过滤（ItemCF）
### <span style="font-size:smaller; color:LightCoral">召回02</span> Swing模型
### <span style="font-size:smaller; color:LightCoral">召回03</span> 基于用户的协同过滤（UserCF）
### <span style="font-size:smaller; color:LightCoral">召回04</span> 离散特征处理
### <span style="font-size:smaller; color:LightCoral">召回05</span> 矩阵补充、最近邻查找
### <span style="font-size:smaller; color:LightCoral">召回06</span> 双塔模型--模型结构、训练方法
### <span style="font-size:smaller; color:LightCoral">召回07</span> 双塔模型--正负样本
### <span style="font-size:smaller; color:LightCoral">召回08</span> 双塔模型--线上服务、模型更新
### <span style="font-size:smaller; color:LightCoral">召回09</span> 双塔模型+自监督学习
### <span style="font-size:smaller; color:LightCoral">召回10</span> Deep Retrieval 召回
### <span style="font-size:smaller; color:LightCoral">召回11</span> 地理位置召回、作者召回、缓存召回
### <span style="font-size:smaller; color:LightCoral">召回12</span> 曝光过滤 & Bloom Filter

## <span>排序</span><a id="排序"></a>
### <span style="font-size:smaller; color:LightCoral">排序01</span> 多目标模型
### <span style="font-size:smaller; color:LightCoral">排序02</span> Multi-gate Mixture-of-Experts (MMoE)
### <span style="font-size:smaller; color:LightCoral">排序03</span> 预估分数融合
### <span style="font-size:smaller; color:LightCoral">排序04</span> 视频播放建模
### <span style="font-size:smaller; color:LightCoral">排序05</span> 排序模型的特征
### <span style="font-size:smaller; color:LightCoral">排序06</span> 粗排模型

## <span>特征交叉</span><a id="特征交叉"></a>
### <span style="font-size:smaller; color:LightCoral">特征交叉01</span> Factorized Machine (FM) 因式分解机
### <span style="font-size:smaller; color:LightCoral">特征交叉02</span> DCN深度交叉网络
### <span style="font-size:smaller; color:LightCoral">特征交叉03</span> LHUC (PPNet)
### <span style="font-size:smaller; color:LightCoral">特征交叉04</span> SENet 和 Bilinear 交叉

## <span>行为序列</span><a id="行为序列"></a>
### <span style="font-size:smaller; color:LightCoral">行为序列01</span> 用户历史行为序列建模
### <span style="font-size:smaller; color:LightCoral">行为序列02</span> DIN模型（注意力机制）
### <span style="font-size:smaller; color:LightCoral">行为序列03</span> SIM模型（长序列建模）

## <span>重排</span><a id="重排"></a>
### <span style="font-size:smaller; color:LightCoral">重排01</span> 物品相似性的度量、提升多样性的方法
### <span style="font-size:smaller; color:LightCoral">重排02</span> MMR(Maximal Marginal Relevance)多样性算法
### <span style="font-size:smaller; color:LightCoral">重排03</span> 业务规则约束下的多样性算法
### <span style="font-size:smaller; color:LightCoral">重排04</span> DPP多样性算法（上）
### <span style="font-size:smaller; color:LightCoral">重排05</span> DPP多样性算法（下）

## <span>物品冷启</span><a id="物品冷启"></a>
### <span style="font-size:smaller; color:LightCoral">物品冷启01</span> 优化目标 & 评价指标
### <span style="font-size:smaller; color:LightCoral">物品冷启02</span> 简单的召回通道
### <span style="font-size:smaller; color:LightCoral">物品冷启03</span> 聚类召回
### <span style="font-size:smaller; color:LightCoral">物品冷启04</span> Look-Alike召回
### <span style="font-size:smaller; color:LightCoral">物品冷启05</span> 流量调控
### <span style="font-size:smaller; color:LightCoral">物品冷启06</span> 冷启的AB测试

## <span>涨指标的方法</span><a id="涨指标"></a>
### <span style="font-size:smaller; color:LightCoral">张指标的方法01</span> 概述
### <span style="font-size:smaller; color:LightCoral">张指标的方法02</span> 召回
### <span style="font-size:smaller; color:LightCoral">张指标的方法03</span> 排序模型
### <span style="font-size:smaller; color:LightCoral">张指标的方法04</span> 多样性
### <span style="font-size:smaller; color:LightCoral">张指标的方法05</span> 特殊用户人群
### <span style="font-size:smaller; color:LightCoral">张指标的方法06</span> 交互行为（关注、转发、评论）